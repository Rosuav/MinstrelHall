<!DOCTYPE HTML>
<html lang=en>
<head>
<title>{{displayname}} Bingo</title>
<style>
table, th, td {border: 1px solid black;}
td {
	width: 7em;
	height: 7em;
	text-align: center;
}
td.marked {
	background: #a0f0c0;
}
td p {margin: 0;}
</style>
</head>
<body>
<h1>{{displayname}} Bingo</h1>
<p>
Spot things as they happen during a <a href="https://twitch.tv/{{channel}}">{{displayname}} live stream</a> and see if you can claim
an entire row or column in a single stream!
</p>
{% if not user %}
<form><p>
Want to be on the leaderboard? <label>Enter your name here: <input name=user></label>
<input type=submit value="Do it!">
</p></form>
{% endif %}
<table>
{% for row in range(5) %}<tr>{% for cell in range(5) %}{% set c = cards[row*5+cell] %}
{% if c[0] %}
<td data-id={{c[0]}}>{{c[1]|markdown}}</td>
{% else %}
<td data-id={{c[0]}} data-freebie=1><b>FREE</b>{{c[1]|markdown}}<b>FREE</b></td>
{% endif %}
{% endfor %}</tr>{% endfor %}
</table>

<p><small>Just for fun.</small></p>
<script>
const cells_by_id = {};
{% if user %}
const protocol = window.location.protocol == "https:" ? "wss://" : "ws://";
const socket = new WebSocket(protocol + window.location.host + "/bingo-live");
function socksend(data) {socket.send(JSON.stringify(data));}
socket.onopen = () => {console.log("Socket connection established."); socksend({type: "init", channel: "{{channel}}", user: "{{user}}"});};
socket.onmessage = (ev) => {
	let msg; try {msg = JSON.parse(ev.data);} catch (e) {}
	if (!msg || !msg.type) return;
	switch (msg.type) {
		case "refresh": window.location.reload(); break;
		case "reset": {
			msg.marked.forEach((status, idx) => cells_by_id[idx].classList.toggle("marked", status));
			break;
		}
		case "mark": cells_by_id[msg.id].classList.toggle("marked", msg.status); break;
		default: console.log("Received message:", ev.data);
	}
};
{% else %}
function socksend(data) {/* no socket when not logged in - nothing persists */}
{% endif %}

function cell_clicked(ev) {
	if (this.dataset.freebie) return; //Can't unmark the freebie
	socksend({type: "mark", id: parseInt(this.dataset.id, 10), status: this.classList.toggle("marked")});
}

document.querySelectorAll("td").forEach(el => {
	el.onclick = cell_clicked;
	if (el.dataset.freebie) el.classList.add("marked");
	cells_by_id[el.dataset.id] = el;
});
</script>
</body>
</html>
